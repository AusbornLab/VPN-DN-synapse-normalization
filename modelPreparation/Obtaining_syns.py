import navis
import cloudvolume as cv
navis.patch_cloudvolume()
from fafbseg import flywire
import fafbseg
import pandas as pd


#The following example goes through DNp01, bnut changing the ID 
DNp01 = 720575940622838154
DNp02 = 720575940619654053
DNp03 = 720575940627645514
DNp04 = 720575940604954289
DNp06 = 720575940622673860

# DN_syn = flywire.get_synapses(DNp01,pre = False, min_score = 50)
# DN_conn = fafbseg.flywire.synapses.get_connectivity(DNp01, downstream = False, min_score = 50)

DN_syn = flywire.get_synapses(DNp06, pre=True, post=True, attach=True, filtered=False, min_score=30, clean=True, materialization=783, batch_size=30, progress=True)
DN_conn = fafbseg.flywire.synapses.get_connectivity(DNp01, clean=True, style='simple', upstream=True, downstream=False, proofread_only=True, filtered=False, min_score=30, batch_size=30, materialization=783, progress=True, )

LC4_ids = [720575940632769180, 720575940638456227, 720575940613256863, 720575940615462587, 720575940634517856, 720575940615575007, 720575940620903551, 720575940618002644, 720575940629753807, 720575940626605200, 720575940622531767, 720575940618312606, 720575940638496720, 720575940625934973, 720575940622939836, 720575940617026260, 720575940616713355, 720575940628462340, 720575940624017251, 720575940614914107, 720575940625991043, 720575940617176321, 720575940630851036, 720575940611134833, 720575940624111763, 720575940618807105, 720575940640612480, 720575940627519107, 720575940615127227, 720575940617266722, 720575940619397542, 720575940628454522, 720575940631338271, 720575940610522009, 720575940649229433, 720575940630998339, 720575940620795728, 720575940618723749, 720575940614572742, 720575940612580977, 720575940613260959, 720575940625038090, 720575940630484495, 720575940626916936, 720575940622108001, 720575940605598892, 720575940615053580, 720575940612518055, 720575940628081541, 720575940628064260, 720575940628699560, 720575940633580384, 720575940626626895, 720575940618676440]
LPLC1_ids = [720575940614089197, 720575940623514467, 720575940625031426, 720575940615362558, 720575940613672931, 720575940645134359, 720575940626667270, 720575940619695494, 720575940608302857, 720575940626260490, 720575940614362380, 720575940640792973, 720575940627806992, 720575940614354326, 720575940621522671, 720575940629778587, 720575940621110464, 720575940611922126, 720575940625175068, 720575940616881821, 720575940625369884, 720575940644971299, 720575940628716294, 720575940610902442, 720575940629047340, 720575940631450669, 720575940608422958, 720575940632086573, 720575940632946477, 720575940614751027, 720575940645750324, 720575940646708788, 720575940630420281, 720575940621403887, 720575940615999547, 720575940616403771, 720575940616201695, 720575940616298816, 720575940619720129, 720575940624588070, 720575940628324802, 720575940629661381, 720575940637905478, 720575940615934150, 720575940624530835, 720575940622694217, 720575940622932297, 720575940632481849, 720575940627555197, 720575940629638443, 720575940639172816, 720575940628856719, 720575940645134103, 720575940612570481, 720575940635631211, 720575940621658971, 720575940629245937, 720575940626721881, 720575940636983518, 720575940640642723, 720575940613304803, 720575940636703977, 720575940619506415, 720575940634361336, 720575940626865148, 720575940622670845, 720575940645744676]
LC22_ids = [720575940639072128,720575940621159302,720575940627419910,720575940627015430,720575940620132999,720575940615964555,720575940616998668,720575940635437966,720575940626392593,720575940616180881,720575940623828884,720575940624292244,720575940633963930,720575940628228251,720575940640747683,720575940647068451,720575940620020390,720575940604268972,720575940626170426,720575940615071675,720575940623993276,720575940608190915,720575940626522440,720575940623434060,720575940611201998,720575940629940431,720575940631806671,720575940620578645,720575940616040153,720575940620877147,720575940635679327,720575940619590241,720575940620218977,720575940623567459,720575940610171234,720575940636884457,720575940621951085,720575940611628145,720575940641736949,720575940650869238,720575940649953913,720575940623706365,720575940613439230]
LPLC4_ids = [720575940627471619, 720575940624864585, 720575940619655685, 720575940620346758, 720575940626408454, 720575940623383432, 720575940636418740, 720575940626435850, 720575940642181005, 720575940623492632, 720575940613238418, 720575940634223514, 720575940628911381, 720575940653172726, 720575940623003653, 720575940640625280, 720575940619014981, 720575940627149514, 720575940622560094, 720575940626886568, 720575940638880582, 720575940633176749, 720575940634839964, 720575940622276735, 720575940646414132, 720575940618818629, 720575940620729816, 720575940641216976, 720575940630321464, 720575940619159233, 720575940613984578, 720575940640353333, 720575940609063236, 720575940625925450, 720575940645336100, 720575940617687382, 720575940635497311, 720575940621759169, 720575940619309632, 720575940624008586, 720575940614209576, 720575940621259875, 720575940624203972, 720575940623961747, 720575940629320010, 720575940623945194, 720575940628523113, 720575940613491826, 720575940620375796, 720575940615044469, 720575940634599650, 720575940621514093, 720575940627363356, 720575940627587459]
LPLC2_ids = [720575940623219038, 720575940626375172, 720575940614738444, 720575940623925774, 720575940611567638, 720575940622680088, 720575940610226645, 720575940645407268, 720575940618608177, 720575940645328436, 720575940617289782, 720575940628552247, 720575940628847164, 720575940613145258, 720575940619900993, 720575940630209603, 720575940636295019, 720575940630731847, 720575940616008854, 720575940630831185, 720575940638835288, 720575940625477721, 720575940632129848, 720575940629292785, 720575940617294219, 720575940627368254, 720575940624531652, 720575940615953302, 720575940615055989, 720575940635307639, 720575940648418425, 720575940627902078, 720575940622312072, 720575940626236041, 720575940617997241, 720575940613219474, 720575940628395797, 720575940647369507, 720575940632779932, 720575940653666465, 720575940639109795, 720575940606126438, 720575940614631079, 720575940635234478, 720575940613763759, 720575940634700980, 720575940635516084, 720575940619981494, 720575940622425271, 720575940608088259, 720575940623551684, 720575940626414279, 720575940625216202, 720575940629368015, 720575940639878352, 720575940632080146, 720575940615332502, 720575940620139678, 720575940624359093, 720575940623652083, 720575940626617084, 720575940623262461, 720575940608875531, 720575940618927892, 720575940611821334, 720575940621914904, 720575940643740964, 720575940612560680, 720575940612874536, 720575940624417584, 720575940624755504, 720575940612096462, 720575940632777124, 720575940628976956, 720575940638626118, 720575940626384200, 720575940613470947, 720575940641704656, 720575940635004271, 720575940636529520, 720575940625700739, 720575940619197318, 720575940607845250, 720575940615907723, 720575940616083345, 720575940623827348, 720575940617480094, 720575940619750822, 720575940625697772, 720575940603989420, 720575940640302389, 720575940655750305, 720575940624208824, 720575940619263937, 720575940607854531, 720575940622009284, 720575940628921303, 720575940616377817, 720575940639895003, 720575940639884878, 720575940632009167, 720575940641552347, 720575940612766691, 720575940642414837, 720575940631380695, 720575940620306904, 720575940622156799]
LC6_ids = [720575940606477746, 720575940610485145, 720575940611518617, 720575940611580313, 720575940612142051, 720575940612227441, 720575940614230495, 720575940615058956, 720575940615123250, 720575940615369266, 720575940616613009, 720575940616715732, 720575940617216320, 720575940617989686, 720575940627141066, 720575940618650584, 720575940619219264, 720575940619419813, 720575940632095695, 720575940620699519, 720575940621953264, 720575940622382320, 720575940622462685, 720575940623272435, 720575940623306739, 720575940623703956, 720575940623737831, 720575940624461319, 720575940624802250, 720575940625048638, 720575940625396226, 720575940625579022, 720575940625623994, 720575940626669114, 720575940626720072, 720575940627003847, 720575940627006794, 720575940627343089, 720575940627740432, 720575940628026112, 720575940628484201, 720575940628684154, 720575940629013292, 720575940628708868, 720575940629204303, 720575940629289721, 720575940630016855, 720575940630466346, 720575940630509098, 720575940631115368, 720575940631745107, 720575940632592609, 720575940635020133, 720575940637042295, 720575940637066047, 720575940637604678, 720575940638210894, 720575940638231997, 720575940638458173, 720575940638900558, 720575940632679736, 720575940645288740, 720575940645925508, 720575940647182644, 720575940609789193]



All_VPNs = LPLC1_ids + LPLC4_ids+ LC4_ids + LC22_ids + LPLC2_ids + LC6_ids

#This is the final command to export synapse locations, after you have labeled each of the inputs/important inputs. 

# Create a temporary df to hold the synapse information from each neuron and then get it into um
temp = DN_syn[['pre','pre_x','pre_y','pre_z','post_x', 'post_y','post_z']]
#temp[['pre_x','pre_y','pre_z','post_x', 'post_y','post_z']] = temp[['pre_x','pre_y','pre_z','post_x', 'post_y','post_z']].div(1000) # This command will get it into ums, otherwise the export is in nm
# select the rows where the synapses are contained according to their typed and updated ID number
LC4_syns = temp[temp['pre'].isin(LC4_ids)]
LC6_syns = temp[temp['pre'].isin(LC6_ids)]
LC22_syns = temp[temp['pre'].isin(LC22_ids)]
LPLC1_syns = temp[temp['pre'].isin(LPLC1_ids)]
LPLC2_syns = temp[temp['pre'].isin(LPLC2_ids)]
LPLC4_syns = temp[temp['pre'].isin(LPLC4_ids)]
Non_VPN_syns = temp[~temp['pre'].isin(All_VPNs)]
# Create a column to label each synapse by the type
LC4_syns["type"] = 'LC4'
LC6_syns["type"] = 'LC6'
LC22_syns["type"] = 'LC22'
LPLC1_syns["type"] = 'LPLC1'
LPLC2_syns["type"] = 'LPLC2'
LPLC4_syns["type"] = 'LPLC4'
Non_VPN_syns["type"] = 'na'

#Concatenate the dfs into one csv to export
lst = [LC4_syns, LC6_syns, LC22_syns, LPLC1_syns, LPLC2_syns, LPLC4_syns, Non_VPN_syns]  # List of your dataframes
DN_syns= pd.concat(lst)

#Convert the pre id number to a str to be able to keep the id numbers in excel
convert_dict = {'pre': str,}
 
DNp01_syn_final= DN_syns.astype(convert_dict)
print(DNp01_syn_final)

LC4_syns = DNp01_syn_final.query('type == "LC4"').count()
LC6_syns = DNp01_syn_final.query('type == "LC6"').count()
LC22_syns = DNp01_syn_final.query('type == "LC22"').count()
LPLC1_syns = DNp01_syn_final.query('type == "LPLC1"').count()
LPLC2_syns = DNp01_syn_final.query('type == "LPLC2"').count()
LPLC4_syns = DNp01_syn_final.query('type == "LPLC4"').count()


print(f"LC4 synapses: {LC4_syns}")
print(f"LC6 synapses: {LC6_syns}")
print(f"LC22 synapses: {LC22_syns}")
print(f"LPLC1 synapses: {LPLC1_syns}")
print(f"LPLC2 synapses: {LPLC2_syns}")
print(f"LPLC4 synapses: {LPLC4_syns}")

#Export the excel sheet
# DNp01_syn_final.to_excel('DNp01_flywire_syn_labeled_nm.xlsx', engine='xlsxwriter')