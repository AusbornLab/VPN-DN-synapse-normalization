##Setting up appropriate libraries, All code is adapted from Morimoto et al (2020) (https://doi.org/10.7554/eLife.57685), and Dombrovski et al (2023) (https://doi.org/10.1038/s41586-022-05562-8)

{
library(natverse)
library(nat.nblast)
library(rjson)
library(alphashape3d)
library(PNWColors)
library(ggplot2)
library(sf)
library(ggExtra)
library(cowplot)
library(reshape2)
library(Hmisc)
library(colorspace)   ## hsv colorspace manipulations
library(R.matlab)
library(tidyverse)
library(alphashape3d) #alpha shape
library(alphahull) #2D alpha hull
library(RColorBrewer)
library(catmaid)
library(sf) #compute line-polygon intersections
library(fafbseg)
library(dplyr)
}
# clean everything up.  
rm(list=ls())

# load Buchner '71 eye map from Andrew Straw----------------------------------------------------------------------------------------------

Npt <- 699
buchner <- read.csv("buchner71_tp.csv", header = FALSE)
buchner <- buchner[1:Npt,]
buchner <- buchner / pi * 180 #to degree

# # plot
# dev.new()
# plot(buchner)

# azimuth and elevation range
range(buchner[buchner[,2] > 70 & buchner[,2] < 110, 1]) 
range(buchner[,2])

# set range
buchner_phi <- c(-10, 160) # for +/ 20
buchner_theta <- c(0, 180)


# define some helper functions -------------------------------------------------------------------------------------------------------

#' make polygons from an ashape
#'
#' Intended to be used with the `$edges` dataframe returned by `alphahull::ashape`. 
#' Correct indices order for easy plotting with `polygon`. If there are multiple
#' connected groups, then return multiple polygons.
#' 
#' @param xy intended to be the edge dataframe of an ashape
#'
#' @return a list of polygons' vertices. Eg. to get the first polygon, `mkpoly(ashape$edges)[[1]][,3:4]`
#' @export
#'
#' @examples
mkpoly <- function(xy) {
  xy <- as.data.frame(xy)[,1:6]
  xy_2 <- xy
  
  # remove singlet
  ind_edge <- c(as.matrix(xy[, 1:2]))
  ind_u <- unique(ind_edge)
  ind_s <- ind_u[sapply(ind_u, function(x) sum(ind_edge %in% x)) == 1]
  while (length(ind_s) > 0) {
    ind_m <- match(ind_s[1], xy[,1]) #find this index
    if (!is.na(ind_m)) {
      xy <- xy[-ind_m,]
    } else {
      ind_m <- match(ind_s[1], xy[,2]) #maybe in the second column
      xy <- xy[-ind_m,]
    }
    # search singlet again
    ind_edge <- c(as.matrix(xy[, 1:2]))
    ind_u <- unique(ind_edge)
    ind_s <- ind_u[sapply(ind_u, function(x) sum(ind_edge %in% x)) == 1]
  }
  
  xyset <- list() # vertices for a list of polygons
  if (dim(xy)[1] > 2) {
    # xy is of [x0 y0 x1 y1]
    N <- 1
    xyset[[N]] <- xy[1,]
    xy <- xy[-1, ]
    ii <- c()
    while (dim(xy)[1] >= 1) {
      ii[1] <- match(tail(xyset[[N]], 1)[2], xy[, 1])
      ii[2] <- match(tail(xyset[[N]], 1)[2], xy[, 2])
      if (!is.na(ii[1])) {
        xyset[[N]] <- rbind(xyset[[N]], xy[ii[1], ])
        xy <- xy[-ii[1], ]
      } else if (!is.na(ii[2])){
        xytmp <- xy[ii[2], c(2,1,5,6,3,4)]
        colnames(xytmp) <- colnames(xyset[[N]])
        xyset[[N]] <- rbind(xyset[[N]], xytmp)
        xy <- xy[-ii[2], ]
      } else {
        N <- N + 1
        xyset[[N]] <- xy[1, ]
        xy <- xy[-1, ]
      }
    }
  }
  return(xyset)
}



#' Polar cooridnate to Mollweide projection
#' 
#' Based on [https://mathworld.wolfram.com/MollweideProjection.html].
#' `NA` are kept in the returned matrix.
#'
#' @param thetaphi An Nx2 matrix of polar coordinate on a unit sphere (drop radius): `[0<=theta<=180, -180<=phi<=180]`
#'
#' @return An Nx2 matrix in Mollweide coordinate
#' @export
#'
#' @examples
Mollweide <- function(thetaphi){
  N0 <- nrow(thetaphi)
  xy0 <- matrix(ncol = 2, nrow = N0)
  # deal with NA
  ii_NA <- is.na(thetaphi[,1]) | is.na(thetaphi[,2])
  thetaphi <- thetaphi[!ii_NA,]
  
  N <- nrow(thetaphi)
  lambda <- thetaphi[,2]/180*pi #longitude
  phi <- (90 - thetaphi[,1])/180*pi #latitude
  xy <- matrix(ncol = 2, nrow = N)
  for (j in 1:N) {
    theta <- asin(2*phi[j]/pi) #initial guess
    if (abs(abs(theta) - pi/2) < 1e-3) {
      xy[j,] <- c(2*sqrt(2)/pi*lambda[j]*cos(theta), sqrt(2)*sin(theta))
    } else {
      dtheta <- 1
      while (dtheta > 1e-3) {
        theta_new <- theta - (2*theta + sin(2*theta) - pi*sin(phi[j])) / (2 + 2*cos(2*theta))
        dtheta <- abs(theta_new - theta)
        theta <- theta_new
      }
      xy[j,] <- c(2*sqrt(2)/pi*lambda[j]*cos(theta), sqrt(2)*sin(theta))
    }
  }
  xy0[!ii_NA,] <- xy
  return(xy0)
}



#' Compute arc length on a unit sphere
#'
#' @param p1,p2 Two 1x2 vectors, two points on a unit sphere, `[theta,phi]` in radian.
#'
#' @return A number
#' @export
#'
#' @examples
#' arcLength([pi/2, pi/2], [pi/2, pi])
arcLength <- function(p1, p2) {
  p1_xyz <- c(sin(p1[1])*cos(p1[2]), sin(p1[1])*sin(p1[2]), cos(p1[1]))
  p2_xyz <- c(sin(p2[1])*cos(p2[2]), sin(p2[1])*sin(p2[2]), cos(p2[1]))
  c2 <- sum((p1_xyz - p2_xyz)^2)
  arc_ang <- acos((2-c2)/2)
  return(arc_ang*1)
}

#-----------------------------------------------
# load neurons from saved data ----------------------------------------------------------------------------------------------------


load("TM5.rda")
load("LO_msh.rda")

##Load neurons from folders
LC4 = "LC4_catmaid_skels"
LC6 = "LC6_catmaid_skels"
LC22 = "LC22_catmaid_skels"
LPLC1 = "LPLC1_catmaid_skels"
LPLC2 = "LPLC2_catmaid_skels"
LPLC4 = "LPLC4_catmaid_skels"

LC4 = read.neurons(file.path(getwd(), LC4))
LC6 = read.neurons(file.path(getwd(), LC6))
LC22 = read.neurons(file.path(getwd(), LC22))
LPLC1 = read.neurons(file.path(getwd(), LPLC1))
LPLC2 = read.neurons(file.path(getwd(), LPLC2))
LPLC4 = read.neurons(file.path(getwd(), LPLC4))

# coord axes --------------------------------------------------------------

# from FAFB
axis_ori <- c(350e3, 350e3, 250e3)
axis_lat <- c(-10000, 0, 0) #green
axis_dor <- c(0, -10000, 0)
axis_post <- c(0, 0, 10000)


# palette ---------------------------------------------------------------------------------------------------------

n_lvl <- 11
getPalette <- colorRampPalette(RColorBrewer::brewer.pal(9, "Blues"))
pal_tar <- getPalette(n_lvl - 1)

# ---------------------------------------------------------------------------


# load neurons from CATMAID server ----------------------------------------
# public server
catmaid_login(server="https://fafb-flywire.catmaid.org")

#Utilizing identified neurons from the codex, utilizing their ids to then pull skeletons from CATMAID
#mesh ids are the same but are in a seperate form to access the flywire mesh of those neurons, while the list is to look for the neurons in CATMAID. All neurons here are from "left" side of brain
LC6_ids = list("720575940606477746", "720575940610485145", "720575940611518617", "720575940611580313", "720575940612142051", "720575940612227441", "720575940614230495", "720575940615058956", "720575940615123250", "720575940615369266", "720575940616613009", "720575940616715732", "720575940617216320", "720575940617989686", "720575940618552881", "720575940618650584", "720575940619219264", "720575940619419813", "720575940619943533", "720575940620699519", "720575940621953264", "720575940622382320", "720575940622462685", "720575940623272435", "720575940623306739", "720575940623703956", "720575940623737831", "720575940624461319", "720575940624802250", "720575940625048638", "720575940625396226", "720575940625579022", "720575940625623994", "720575940626669114", "720575940626720072", "720575940627003847", "720575940627006794", "720575940627343089", "720575940627740432", "720575940628026112", "720575940628484201", "720575940628684154", "720575940629013292", "720575940629133884", "720575940629204303", "720575940629289721", "720575940630016855", "720575940630466346", "720575940630509098", "720575940631115368", "720575940631745107", "720575940632592609", "720575940635020133", "720575940635636837", "720575940637066047", "720575940637604678", "720575940638210894", "720575940638231997", "720575940638458173", "720575940638900558", "720575940642907080", "720575940645288740", "720575940645925508", "720575940647182644", "720575940655546017")
LC6_ids_mesh = c("720575940606477746", "720575940610485145", "720575940611518617", "720575940611580313", "720575940612142051", "720575940612227441", "720575940614230495", "720575940615058956", "720575940615123250", "720575940615369266", "720575940616613009", "720575940616715732", "720575940617216320", "720575940617989686", "720575940618552881", "720575940618650584", "720575940619219264", "720575940619419813", "720575940619943533", "720575940620699519", "720575940621953264", "720575940622382320", "720575940622462685", "720575940623272435", "720575940623306739", "720575940623703956", "720575940623737831", "720575940624461319", "720575940624802250", "720575940625048638", "720575940625396226", "720575940625579022", "720575940625623994", "720575940626669114", "720575940626720072", "720575940627003847", "720575940627006794", "720575940627343089", "720575940627740432", "720575940628026112", "720575940628484201", "720575940628684154", "720575940629013292", "720575940629133884", "720575940629204303", "720575940629289721", "720575940630016855", "720575940630466346", "720575940630509098", "720575940631115368", "720575940631745107", "720575940632592609", "720575940635020133", "720575940635636837", "720575940637066047", "720575940637604678", "720575940638210894", "720575940638231997", "720575940638458173", "720575940638900558", "720575940642907080", "720575940645288740", "720575940645925508", "720575940647182644", "720575940655546017")
LC4_ids = list("720575940605598892", "720575940610522009", "720575940611134833", "720575940612518055", "720575940612580977", "720575940613022175", "720575940613256863", "720575940613260959", "720575940614572742", "720575940614914107", "720575940615053580", "720575940615127227", "720575940615462587", "720575940615575007", "720575940616713355", "720575940617026260", "720575940617176321", "720575940617266722", "720575940618002644", "720575940618113300", "720575940618312606", "720575940618371520", "720575940618676440", "720575940618723749", "720575940618807105", "720575940619315696", "720575940619397542", "720575940619700229", "720575940620903551", "720575940622531767", "720575940622539800", "720575940622939836", "720575940624111763", "720575940625038090", "720575940625934973", "720575940625991043", "720575940626626895", "720575940626916936", "720575940628064260", "720575940628454522", "720575940628462340", "720575940629753807", "720575940630484495", "720575940630826552", "720575940630851036", "720575940630998339", "720575940631338271", "720575940632769180", "720575940633580384", "720575940634517856", "720575940638456227", "720575940638496720", "720575940640612480", "720575940649229433")
LC4_ids_mesh = c("720575940605598892", "720575940610522009", "720575940611134833", "720575940612518055", "720575940612580977", "720575940613022175", "720575940613256863", "720575940613260959", "720575940614572742", "720575940614914107", "720575940615053580", "720575940615127227", "720575940615462587", "720575940615575007", "720575940616713355", "720575940617026260", "720575940617176321", "720575940617266722", "720575940618002644", "720575940618113300", "720575940618312606", "720575940618371520", "720575940618676440", "720575940618723749", "720575940618807105", "720575940619315696", "720575940619397542", "720575940619700229", "720575940620903551", "720575940622531767", "720575940622539800", "720575940622939836", "720575940624111763", "720575940625038090", "720575940625934973", "720575940625991043", "720575940626626895", "720575940626916936", "720575940628064260", "720575940628454522", "720575940628462340", "720575940629753807", "720575940630484495", "720575940630826552", "720575940630851036", "720575940630998339", "720575940631338271", "720575940632769180", "720575940633580384", "720575940634517856", "720575940638456227", "720575940638496720", "720575940640612480", "720575940649229433")
LC22_ids = list("720575940604268972", "720575940607074057", "720575940608190915", "720575940610171234", "720575940611201998", "720575940611628145", "720575940613439230", "720575940613831570", "720575940615071675", "720575940615964555", "720575940616040153", "720575940616180881", "720575940616801425", "720575940618785995", "720575940619590241", "720575940620020390", "720575940620132999", "720575940620218977", "720575940620578645", "720575940620877147", "720575940621159302", "720575940623567459", "720575940623706365", "720575940623828884", "720575940623993276", "720575940624292244", "720575940626170426", "720575940626392593", "720575940626522440", "720575940627015430", "720575940627419910", "720575940628063387", "720575940628228251", "720575940629940431", "720575940633963930", "720575940635113151", "720575940635437966", "720575940635679327", "720575940636884457", "720575940639072128", "720575940641736949", "720575940647068451", "720575940649953913", "720575940650869238")
LC22_ids_mesh = c("720575940604268972", "720575940607074057", "720575940608190915", "720575940610171234", "720575940611201998", "720575940611628145", "720575940613439230", "720575940613831570", "720575940615071675", "720575940615964555", "720575940616040153", "720575940616180881", "720575940616801425", "720575940618785995", "720575940619590241", "720575940620020390", "720575940620132999", "720575940620218977", "720575940620578645", "720575940620877147", "720575940621159302", "720575940623567459", "720575940623706365", "720575940623828884", "720575940623993276", "720575940624292244", "720575940626170426", "720575940626392593", "720575940626522440", "720575940627015430", "720575940627419910", "720575940628063387", "720575940628228251", "720575940629940431", "720575940633963930", "720575940635113151", "720575940635437966", "720575940635679327", "720575940636884457", "720575940639072128", "720575940641736949", "720575940647068451", "720575940649953913", "720575940650869238")
LPLC1_ids = list("720575940604710112", "720575940605598594", "720575940608302857", "720575940608422958", "720575940610902442", "720575940611922126", "720575940612570481", "720575940613228241", "720575940613304803", "720575940613672931", "720575940614089197", "720575940614354326", "720575940614362380", "720575940614453679", "720575940614751027", "720575940615934150", "720575940615999547", "720575940616266582", "720575940616298816", "720575940616403771", "720575940616881821", "720575940616934356", "720575940619506415", "720575940619695494", "720575940619720129", "720575940621110464", "720575940621403887", "720575940621722032", "720575940621828863", "720575940622670845", "720575940622694217", "720575940622932297", "720575940623514467", "720575940624305737", "720575940625031426", "720575940625175068", "720575940625369884", "720575940626260490", "720575940626667270", "720575940626721881", "720575940626865148", "720575940627555197", "720575940627806992", "720575940628324802", "720575940628716294", "720575940629047340", "720575940629079145", "720575940629661381", "720575940629778587", "720575940630088389", "720575940630420281", "720575940631450669", "720575940632086573", "720575940632481849", "720575940632946477", "720575940634361336", "720575940635631211", "720575940636703977", "720575940636983518", "720575940637905478", "720575940638787133", "720575940639172816", "720575940640792973", "720575940644971299", "720575940645134103", "720575940645134359", "720575940645750324", "720575940646708788")
LPLC1_ids_mesh = c("720575940604710112", "720575940605598594", "720575940608302857", "720575940608422958", "720575940610902442", "720575940611922126", "720575940612570481", "720575940613228241", "720575940613304803", "720575940613672931", "720575940614089197", "720575940614354326", "720575940614362380", "720575940614453679", "720575940614751027", "720575940615934150", "720575940615999547", "720575940616266582", "720575940616298816", "720575940616403771", "720575940616881821", "720575940616934356", "720575940619506415", "720575940619695494", "720575940619720129", "720575940621110464", "720575940621403887", "720575940621722032", "720575940621828863", "720575940622670845", "720575940622694217", "720575940622932297", "720575940623514467", "720575940624305737", "720575940625031426", "720575940625175068", "720575940625369884", "720575940626260490", "720575940626667270", "720575940626721881", "720575940626865148", "720575940627555197", "720575940627806992", "720575940628324802", "720575940628716294", "720575940629047340", "720575940629079145", "720575940629661381", "720575940629778587", "720575940630088389", "720575940630420281", "720575940631450669", "720575940632086573", "720575940632481849", "720575940632946477", "720575940634361336", "720575940635631211", "720575940636703977", "720575940636983518", "720575940637905478", "720575940638787133", "720575940639172816", "720575940640792973", "720575940644971299", "720575940645134103", "720575940645134359", "720575940645750324", "720575940646708788")
LPLC2_ids = list("720575940626375172", "720575940608875531", "720575940614738444", "720575940623925774", "720575940611567638", "720575940622680088", "720575940625695269", "720575940630302250", "720575940618608177", "720575940645328436", "720575940617289782", "720575940628552247", "720575940628847164", "720575940619900993", "720575940630209603", "720575940637193798", "720575940630731847", "720575940620946508", "720575940639884878", "720575940630831185", "720575940638835288", "720575940625477721", "720575940608617564", "720575940607288924", "720575940635576432", "720575940612605554", "720575940619919476", "720575940615055989", "720575940635307639", "720575940648418425", "720575940627902078", "720575940622312072", "720575940626236041", "720575940613219474", "720575940615332502", "720575940627663512", "720575940610946713", "720575940627683483", "720575940632779932", "720575940653666465", "720575940639109795", "720575940614631079", "720575940613145258", "720575940635234478", "720575940613763759", "720575940634700980", "720575940624359093", "720575940619981494", "720575940622425271", "720575940635516084", "720575940608088259", "720575940623551684", "720575940626414279", "720575940625216202", "720575940629368015", "720575940639878352", "720575940613470947", "720575940622093546", "720575940623652083", "720575940626617084", "720575940623262461", "720575940623543565", "720575940618927892", "720575940611821334", "720575940621914904", "720575940643740964", "720575940612560680", "720575940612874536", "720575940624417584", "720575940624755504", "720575940632129848", "720575940628976956", "720575940615957314", "720575940638626118", "720575940626384200", "720575940606126438", "720575940635004271", "720575940636529520", "720575940607845250", "720575940625700739", "720575940627685765", "720575940619197318", "720575940615907723", "720575940617294219", "720575940616083345", "720575940623827348", "720575940612159381", "720575940617480094", "720575940632777124", "720575940619750822", "720575940620115878", "720575940603989420", "720575940622455223", "720575940624208824", "720575940617997241", "720575940619263937", "720575940607854531", "720575940622009284", "720575940612096462", "720575940628921303", "720575940620306904", "720575940616377817", "720575940639895003", "720575940641552347", "720575940612766691", "720575940619935214", "720575940619398127", "720575940622156799")
LPLC2_ids_mesh = c("720575940626375172", "720575940608875531", "720575940614738444", "720575940623925774", "720575940611567638", "720575940622680088", "720575940625695269", "720575940630302250", "720575940618608177", "720575940645328436", "720575940617289782", "720575940628552247", "720575940628847164", "720575940619900993", "720575940630209603", "720575940637193798", "720575940630731847", "720575940620946508", "720575940639884878", "720575940630831185", "720575940638835288", "720575940625477721", "720575940608617564", "720575940607288924", "720575940635576432", "720575940612605554", "720575940619919476", "720575940615055989", "720575940635307639", "720575940648418425", "720575940627902078", "720575940622312072", "720575940626236041", "720575940613219474", "720575940615332502", "720575940627663512", "720575940610946713", "720575940627683483", "720575940632779932", "720575940653666465", "720575940639109795", "720575940614631079", "720575940613145258", "720575940635234478", "720575940613763759", "720575940634700980", "720575940624359093", "720575940619981494", "720575940622425271", "720575940635516084", "720575940608088259", "720575940623551684", "720575940626414279", "720575940625216202", "720575940629368015", "720575940639878352", "720575940613470947", "720575940622093546", "720575940623652083", "720575940626617084", "720575940623262461", "720575940623543565", "720575940618927892", "720575940611821334", "720575940621914904", "720575940643740964", "720575940612560680", "720575940612874536", "720575940624417584", "720575940624755504", "720575940632129848", "720575940628976956", "720575940615957314", "720575940638626118", "720575940626384200", "720575940606126438", "720575940635004271", "720575940636529520", "720575940607845250", "720575940625700739", "720575940627685765", "720575940619197318", "720575940615907723", "720575940617294219", "720575940616083345", "720575940623827348", "720575940612159381", "720575940617480094", "720575940632777124", "720575940619750822", "720575940620115878", "720575940603989420", "720575940622455223", "720575940624208824", "720575940617997241", "720575940619263937", "720575940607854531", "720575940622009284", "720575940612096462", "720575940628921303", "720575940620306904", "720575940616377817", "720575940639895003", "720575940641552347", "720575940612766691", "720575940619935214", "720575940619398127", "720575940622156799")
LPLC4_ids = list("720575940640625280", "720575940627471619", "720575940646774148", "720575940619655685", "720575940626408454", "720575940620346758", "720575940623383432", "720575940609185289", "720575940626435850", "720575940608828939", "720575940624008586", "720575940642181005", "720575940628027791", "720575940613238418", "720575940623961747", "720575940615081366", "720575940623492632", "720575940634223514", "720575940634839964", "720575940627115294", "720575940618094494", "720575940644795428", "720575940614209576", "720575940626886568", "720575940633176749", "720575940616593714", "720575940614730035", "720575940646414132", "720575940630835511", "720575940630321464", "720575940625574844", "720575940619159233", "720575940619819329", "720575940613984578", "720575940609063236", "720575940618818629", "720575940638880582", "720575940625925450", "720575940629105487", "720575940641216976", "720575940636631386", "720575940622560094", "720575940635497311", "720575940621259875", "720575940628523113", "720575940638338281", "720575940623945194", "720575940621514093", "720575940613491826", "720575940620375796", "720575940615044469", "720575940653172726", "720575940635213431", "720575940630303870", "720575940622276735")
LPLC4_ids_mesh = c("720575940640625280", "720575940627471619", "720575940646774148", "720575940619655685", "720575940626408454", "720575940620346758", "720575940623383432", "720575940609185289", "720575940626435850", "720575940608828939", "720575940624008586", "720575940642181005", "720575940628027791", "720575940613238418", "720575940623961747", "720575940615081366", "720575940623492632", "720575940634223514", "720575940634839964", "720575940627115294", "720575940618094494", "720575940644795428", "720575940614209576", "720575940626886568", "720575940633176749", "720575940616593714", "720575940614730035", "720575940646414132", "720575940630835511", "720575940630321464", "720575940625574844", "720575940619159233", "720575940619819329", "720575940613984578", "720575940609063236", "720575940618818629", "720575940638880582", "720575940625925450", "720575940629105487", "720575940641216976", "720575940636631386", "720575940622560094", "720575940635497311", "720575940621259875", "720575940628523113", "720575940638338281", "720575940623945194", "720575940621514093", "720575940613491826", "720575940620375796", "720575940615044469", "720575940653172726", "720575940635213431", "720575940630303870", "720575940622276735")

# These are the "right" side of the brain LPLC2.
LPLC2_r_ids = list('720575940611088370','720575940613427198','720575940621536937','720575940622268853','720575940623225525',
            '720575940623935588','720575940628884486','720575940632912409','720575940634502812','720575940636536286',
            '720575940637368286','720575940603817900','720575940604016608','720575940608496196','720575940611050649',
            '720575940611249528','720575940611314346','720575940612732146','720575940613088322','720575940613677999',
            '720575940614373023','720575940614599071','720575940616938385','720575940617414539','720575940619518854',
            '720575940620443162','720575940620512950','720575940620754815','720575940621061545','720575940621092220',
            '720575940621747917','720575940621785129','720575940622314339','720575940622700201','720575940622713929',
            '720575940623126419','720575940623148105','720575940623547431','720575940623587683','720575940623887288',
            '720575940624459557','720575940624827737','720575940624868196','720575940624924990','720575940625318804',
            '720575940626226576','720575940626324755','720575940626507408','720575940626510869','720575940626531914',
            '720575940626661704','720575940627240537','720575940627279134','720575940627427015','720575940627910021',
            '720575940627957893','720575940628473214','720575940629325611','720575940629489116','720575940629787223',
            '720575940629854055','720575940630123794','720575940631059501','720575940631123759','720575940631430674',
            '720575940634857583','720575940635714399','720575940636229342','720575940636795620','720575940638065571',
            '720575940638177246','720575940638644096'
)

LPLC2_r_ids = list("720575940605669321","720575940605825666","720575940606217138","720575940606855554","720575940607683011","720575940607883442","720575940609592674","720575940610116757","720575940610536290","720575940610681829","720575940610855061","720575940610953651","720575940611352234","720575940611740569","720575940611891990","720575940612045352","720575940612254701","720575940612462307","720575940612944382","720575940613804906","720575940613821290","720575940614067167","720575940614373279","720575940614502854","720575940614526974","720575940615116731","720575940615288203","720575940615920453","720575940615967377","720575940616116697","720575940616166685","720575940616491993","720575940616587803","720575940616735489","720575940617569344","720575940618450496","720575940618711535","720575940619627934","720575940619654149","720575940620001718","720575940620575476","720575940620783180","720575940620887834","720575940621634913","720575940622174463","720575940622253526","720575940622258473","720575940622769159","720575940622992205","720575940623047629","720575940623769783","720575940624014524","720575940624016778","720575940624244922","720575940624611002","720575940624903064","720575940624919077","720575940624931530","720575940625399652","720575940626161930","720575940626447848","720575940626735016","720575940626873000","720575940627876807","720575940627902979","720575940628197892","720575940628603842","720575940628778058","720575940628990214","720575940629384271","720575940629967703","720575940630650936","720575940630719831","720575940631095158","720575940631397549","720575940631582751","720575940632512226","720575940632711052","720575940633588320","720575940634146967","720575940634260079","720575940634684267","720575940634896992","720575940635040357","720575940635572592","720575940636539102","720575940636878682","720575940636950505","720575940636999401","720575940637088602","720575940637702222","720575940637958709","720575940638161486","720575940638857048","720575940638922624","720575940640510427","720575940642397128","720575940645180196","720575940645699124","720575940653742753","720575940623333770","720575940628039034"
)


neu_list <- list()
LPLC2 <- neu_list
# Iterate through the LC/LPLC IDs and retrieve neuron data
for (id in LC4_ids) {
  # Query Catmaid and retrieve neuron data
  neu_data <- catmaid_query_by_name(id)
  
  # Extract the skid
  neu_skid <- neu_data$skid
  
  # Read neuron data using the skid
  neu <- read.neurons.catmaid(neu_skid, .progress='text')
  
  # Append the neuron data to the list
  neu_list <- c(neu_list,neu)
}
#Saving the skeletons to a folder to then load later for analysis, change your file path below.
for (x in 1:length(neu_list)) {
  file_name <- paste0(neu_list[[x]][1], ".swc")
  file_path <- file.path("C:/Users/antho/Documents/Downloads/LC4_catmaid_skels", file_name)
  write.neuron(neu_list[[x]], file = file_path)
}


